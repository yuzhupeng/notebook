

[æ–°ç“¶è£…è€é…’--è¿‘æœŸAPT32ï¼ˆæµ·è²èŠ±ï¼‰ç»„ç»‡æ”»å‡»æ´»åŠ¨æ ·æœ¬åˆ†æ](https://mp.weixin.qq.com/s/U9LIfVVP5kHBFFt0LN0Q-A?ref=www.ctfiot.com)

å¥½çš„æ–‡ç« ,å€¼å¾—å­¦ä¹ 

[Bypassing User-Mode Hooks and Direct Invocation of System Calls for Red Teams - MDSec](https://www.mdsec.co.uk/2020/12/bypassing-user-mode-hooks-and-direct-invocation-of-system-calls-for-red-teams/)

[æ€»ç»“åˆ°ç›®å‰ä¸ºæ­¢å‘ç°çš„æ‰€æœ‰EDRç»•è¿‡æ–¹æ³•-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘](https://cloud.tencent.com/developer/article/1794090)

[A tale of EDR bypass methods | S3cur3Th1sSh1t](https://s3cur3th1ssh1t.github.io/A-tale-of-EDR-bypass-methods/)

[https://github.com/leftp/AQUARMOURY](https://github.com/leftp/AQUARMOURY)

[https://github.com/chvancooten/NimPackt-v1](https://github.com/chvancooten/NimPackt-v1)

[https://github.com/hlldz/RefleXXion](https://github.com/hlldz/RefleXXion)

[https://github.com/CKevens/CobaltStrike-4.8-Cracked](https://github.com/CKevens/CobaltStrike-4.8-Cracked)

[https://github.com/NextronSystems/APTSimulator](https://github.com/NextronSystems/APTSimulator)

[2022é›¶åŸºç¡€éŸ­èœæˆé•¿è®¡åˆ’ä¹‹çº¢é˜Ÿå…¥é—¨å®æˆ˜-å…&æ€(éƒ¨åˆ†å…¬å¼€å†…å®¹)_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1YZ4y1C7cm)

[2017å…æ€å®æˆ˜_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1xL411E7Af)



# ä¸»è¿›ç¨‹åˆ†æ



æ¥ç€åˆå†æ¬¡åˆ›å»ºè¿›ç¨‹å’Œå…³é—­å¥æŸ„

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled6.png)

åˆ›å»ºäº†windowsä¸‹çš„`C :\Windows\System32\TapiUnattend.exe` 

åˆ›å»ºè¿›ç¨‹çš„æœ€å1ä¸€ä¸ªå‚æ•°å¦‚ä¸‹

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled7.png)

æœŸé—´å…³é—­äº†`ç®¡é“1çš„è¯»å¥æŸ„`,`ç®¡é“2çš„å†™å¥æŸ„`

æ‰€ä»¥æœ€åç•™ä¸‹çš„æ˜¯`ç®¡é“1çš„å†™å¥æŸ„`å’Œ`ç®¡é“2çš„è¯»å¥æŸ„`

åˆ›å»ºè¿›ç¨‹å,å¯¹è¿›ç¨‹çš„çº¿ç¨‹åšäº†ä¸€ä¸ªåœæ­¢

```c
typedef struct _PROCESS_INFORMATION {
    HANDLE hProcess;
    HANDLE hThread;
    DWORD dwProcessId;
    DWORD dwThreadId;
} PROCESS_INFORMATION, *PPROCESS_INFORMATION, *LPPROCESS_INFORMATION;
```

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled8.png)

æ¥ç€åˆå…³é—­äº†è¿›ç¨‹å¥æŸ„,çº¿ç¨‹å¥æŸ„,å’Œå‰©ä¸‹çš„æ‰€æœ‰ç®¡é“å¥æŸ„

åæ­£,ä¸çŸ¥é“å®ƒåˆ›å»ºç®¡é“æ˜¯å¹²ä»€ä¹ˆçš„

ä¹Ÿæ²¡æœ‰å¾€é‡Œé¢å†™å…¥ä»€ä¹ˆä¸œè¥¿

å‰é¢å‡ æ¬¡çš„å†…å­˜åˆ†é…ä¹Ÿæ˜¯åŒç†,åˆ†é…äº†,ä¸çŸ¥é“éƒ½å¹²ä»€ä¹ˆäº†

ç„¶åå†æ‰“å¼€è¿œç¨‹è¿›ç¨‹

åœ¨è¿œç¨‹è¿›ç¨‹åˆ†é…å†…å­˜

ç„¶åå†åˆ›å»ºè¿œç¨‹çº¿ç¨‹

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled9.png)

çº¿ç¨‹æ‰§è¡Œæ²¡æœ‰å‚æ•°

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled10.png)

è¿œç¨‹è¿›ç¨‹çš„æ‰§è¡Œä»£ç æ˜¯ä¸€æ®µshellcode

shellcodeæå–å¦‚ä¸‹

```c
#include<idc.idc>

static format_binFile()
{
    auto i;
    auto flen=8717;
    auto start_addr=0x000001719ACE9040;
    auto fd = fopen("shellcode.bin", "w"); 
    for(i=0;i<flen;i=i+1)
    {
        fputc(Byte(start_addr+i),fd);
    }
    fclose(fd);
}
static main()
{
    Message("| -- Y -- |\n");
    format_binFile();
    Message("| -- N -- |\n");
}
```

ps: 

æˆ‘æ˜¯é‡æ–°è°ƒè¯•è¿›ç¨‹,æ‰¾åˆ°å…³é”®ä½ç½®,ç„¶åæå–çš„æ•°æ®

å¦å¤–,shellcodeç›´æ¥æœç´¢å­—èŠ‚ç æœä¸åˆ°,è¯´æ˜è¢«åŠ å¯†äº†çš„

åˆ›å»ºè¿œç¨‹çº¿ç¨‹ç„¶å,å…³é—­2ä¸ªå¥æŸ„

ç„¶ååˆå¼€å§‹ æ‰“å¼€ç›¸åŒçš„è¿›ç¨‹

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled12.png)

å†æ¬¡è¿œç¨‹çº¿ç¨‹æ³¨å…¥

å‡½æ•°è¿˜æ˜¯ä»¥å‰çš„å‡½æ•°,åªä¸è¿‡å‡½æ•°å‚æ•°å‘ç”Ÿäº†æ”¹å˜

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled13.png)

ç„¶åä¸»è¿›ç¨‹å¹²çš„äº‹æƒ…å°±æ²¡äº†

å¯ä»¥çœ‹å‡ºä¸»è¿›ç¨‹å°±å¹²äº†2é—´äº‹æƒ… æ³¨å…¥çº¿ç¨‹

# shellcode

æˆ‘æ˜¯é€šè¿‡æ‰“æ–­ç‚¹çš„æ–¹å¼,æŠŠshellcodeä»å†…å­˜é‡Œé¢æå–å‡ºæ¥çš„

æ¯”å¦‚è¯´,Aè¿œç¨‹çº¿ç¨‹æ³¨å…¥B

IDAç›´æ¥è°ƒè¯•A,é™„åŠ è°ƒè¯•B

å¯¹è¿›ç¨‹B: æ–­ç‚¹äºçº¿ç¨‹å¼€å§‹çš„æ—¶å€™,

å½“Aåˆ›å»ºè¿œç¨‹çº¿ç¨‹å®Œæ¯•,æˆ‘ä»¬å°±å¯ä»¥å»Bè¿›ç¨‹æŠŠå®é™…è¿è¡Œçš„å­—èŠ‚ç ç»™dumpå‡ºæ¥

ps: æˆ‘ä¸ºä»€ä¹ˆä¸åœ¨Aä¸­æŠŠå­—èŠ‚ç dumpå‡ºæ¥? å°è¯•è¿‡,å‘ç°æ•ˆæœä¸æ˜¯ç†æƒ³â€¦ä¸è¿‡æ‹¿åˆ°å°±å¯ä»¥,ç®¡ä»–é‚£ä¹ˆå¤šæ–¹å¼,å»è¿›ç¨‹Bæ‹¿å­—èŠ‚ç æ‰æ˜¯æœ‰æ•ˆæ¨¡æ‹Ÿç¯å¢ƒ

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled14.png)

## shellcode.1

åæœŸåˆ†æå‡º,ç¬¬ä¸€æ®µshellcodeå…¶å®æ˜¯ä¸€ä¸ªpeåŠ è½½å™¨, ä»–ä¼šæ‰‹åŠ¨æŠŠä¸€ä¸ªæ–‡ä»¶peæ˜ å°„åˆ°å†…å­˜

ç„¶ååšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œ,æœ€åå»å¾€epæ‰§è¡Œ

### PEåŠ è½½å™¨åˆ†æ

æ‰€ä»¥è¯´å…¶å®laoderåˆ†æçš„æ„ä¹‰ä¸å¤ªå¤§,è€Œåªéœ€è¦å…³å¿ƒå…·ä½“åŠ è½½çš„æ˜¯ä»€ä¹ˆpeæ–‡ä»¶

è¿™ä¸ªæ–‡ä»¶éƒ½å¹²äº†ä»€ä¹ˆ,åæœŸå‘ç°ä»–æ˜¯ä¸€ä¸ªx64çš„dllæ–‡ä»¶

å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°PE_loader,æ‰€ä»¥æˆ‘ä»¬å°±å¤§æ¦‚åˆ†æä¸€ä¸‹

é¦–å…ˆæ˜¯åŠ¨æ€è·å–API

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled15.png)

ä»–çš„APIè·å–æ¯”è¾ƒæœ‰æ„æ€

é€šè¿‡ç±»ä¼¼äºCRC64çš„ç®—æ³•,(å¯èƒ½ä¸æ˜¯è¿™ä¸ªç®—æ³•å“ˆ,,ğŸ¤£) æ¥æ˜ å°„ä¸€ä¸ªdllå¯¹åº”çš„API

æ¯”å¦‚0x726774Cæ˜ å°„çš„æ˜¯kernel32çš„LoadLibraryA

ğŸ’¡ å…·ä½“å¦‚ä½•åŠ è½½çš„API?

å°±å°å°çš„æåŠä¸€å¥:

å…ˆé€šè¿‡TEBâ†’PEB0â†’Ldrâ†’_LDR_DATA_TABLE_ENTRYéå†è‡ªèº«æ¨¡å—, 

éå†æ¨¡å—Açš„æ—¶å€™, æ¯ä¸€ä¸ªæ¨¡å—çš„dllå­—ç¬¦ä¸²åå­—å¯ä»¥è®¡ç®—å‡ºä¸€ä¸ªæ ¡éªŒå€¼key_A

æ‰¾åˆ°æ¨¡å—Aå.å°±éå†dllçš„å¯¼å‡ºè¡¨çš„å¯¼å‡ºå‡½æ•°

æ¯ä¸ªå‡½æ•°çš„å­—ç¬¦ä¸²åå­—ä¹Ÿå¯¹åº”ä¸€ä¸ªæ ¡éªŒå€¼key_B

é€šè¿‡è®¡ç®—key_A+key_B æ˜¯å¦å’Œä¼ é€’è¿›æ¥çš„ç›®æ ‡api_keyç›¸ç­‰æ¥åˆ¤æ–­

å¯ä»¥çœ‹åˆ°,å…¶å®ä»–ä¼šéå†æ¯ä¸€ä¸ªdllçš„æ¯ä¸€ä¸ªapi,

è€Œä¸æ˜¯å…ˆå¯»æ‰¾dll,ç„¶åå¯»æ‰¾api,è€Œæ˜¯æœ‰é¡ºåºçš„éå†æ‰€æœ‰api,ç›´åˆ°æ‰¾åˆ°ç›®æ ‡api

---

ä¸€å¼€å§‹åŠ¨æ€è·å–çš„APIå…¶å®éƒ½æ˜¯ä¸ºäº†åŠ è½½PEæ–‡ä»¶æœåŠ¡çš„,çœ‹ä¸Šå»ä¹ˆæœ‰æ¶æ„çš„è¡Œä¸º,éƒ½æ˜¯ä¸ºäº†åŠ è½½peè€Œè·å–çš„API

æ¯”å¦‚ VirtualAlloc, VirtualProtect, 

åŠ¨æ€åŠ è½½APiå,å®ƒä¼šåˆ¤æ–­æ˜¯ä¸æ˜¯ä¸€ä¸ªpeæ–‡ä»¶

å¹¶åˆ¤æ–­è¯¥peæ–‡ä»¶æ˜¯å¦åˆæ³•

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled16.png)

ç„¶åä¸‹é¢çš„ä»£ç æˆªå›¾æœ‰ç‚¹é•¿,å°±ä¸å±•ç¤ºäº†,å¤§æ¦‚æµç¨‹å¦‚ä¸‹

```c
peå¤´å¤åˆ¶
peèŠ‚åŒºæ˜ å°„
DataDirectory[5] åŸºå€é‡å®šä½æ“ä½œ
DataDirectory[1] å¯¼å…¥è¡¨åˆå§‹åŒ–
DataDirectory[13] å»¶è¿Ÿå¯¼å…¥è¡¨æ“ä½œ
VirtualProtect èŠ‚åŒºå±æ€§è®¾ç½®
DataDirectory[9] TLSæ“ä½œ
AddressOfEntryPoint å»å¾€ep
DataDirectory[0] æ‰§è¡Œå¯¼å‡ºè¡¨çš„ä¸€äº›ä¸œä¸œ
```

### dllæ–‡ä»¶åˆ†æ

å…¶å®å°±æ˜¯ä»peloaderåŠ è½½ä¹‹å‰,æŠŠæ–‡ä»¶ç»™dumpå‡ºæ¥

æœ¬æ¥æ˜¯å°è¯•ä»å†…å­˜é‡Œé¢dumpå‡ºæ¥çš„,ç„¶åå‘ç°IDAç¼–è¯‘æœ‰é—®é¢˜

å› ä¸ºæˆ‘æ²¡æœ‰æŠŠè¿›è¡Œä¸€ä¸ªæŠŠå†…å­˜æ˜ å°„åˆ°æ–‡ä»¶çš„æ“ä½œ,æ‰€ä»¥IDAç¿»è¯‘å°±æœ‰é—®é¢˜

å†™äº†dumpçš„ç¨‹åº,é‡æ–°æŠŠå†…å­˜dumpçš„å¤„ç†äº†ä¸€ä¸‹,å…¶å®ä¹Ÿå°±æ˜¯æŠŠèŠ‚åŒºå¤šä½™çš„å­—èŠ‚åˆ é™¤äº†,å……VirusSizeå‡å°‘åˆ°RawSize

åæ¥å‘ç°è¿˜æ˜¯æœ‰é—®é¢˜,,,,æ‰€ä»¥æˆ‘åªèƒ½åœ¨æ–‡ä»¶è¿˜æ²¡æœ‰æ˜ å°„åˆ°å†…å­˜ä¹‹å‰dumpäº†,è€Œä¸æ˜¯dump åŠ è½½å™¨ å»å¾€ç¨‹åºepçš„

æ²¡åŠ è½½ä¹‹å‰æˆªèƒ¡æ–‡ä»¶æ˜¯è«é—®é¢˜çš„,åæ¥å¯¹æ¯”äº†ä¸€ä¸‹

æˆ‘å¤„ç†çš„æ–‡ä»¶å’Œä¸€å¼€å§‹å°±æˆªèƒ¡çš„æ–‡ä»¶,å‘ç°å°‘äº†å¾ˆå¤šä¸œè¥¿

è¿™ä»€ä¹ˆâ€¦ä»–å–µçš„â€¦.è¿˜å¾—æ˜¯åŠ è½½ä¹‹å‰åŸæ±åŸå‘³

DllMainå°±è°ƒç”¨äº†ä¸€ä¸ªå‡½æ•°

```c
BOOL __stdcall DllEntryPoint(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpReserved)
{
  if ( fdwReason == 1 )
    sub_180001820(hinstDLL);
  return 1;
}
```

å¯¹äºdllæ–‡ä»¶,æˆ‘ä¹Ÿå°±çœ‹äº†ä¸€ä¸ªå¤§æ¦‚

æ€»ä½“æ¥è¯´,æ„Ÿè§‰å°±æ˜¯ä¿®æ”¹äº†`TapiUnattend`.exe  çš„ntdll.dll çš„.textçš„èŠ‚åŒºå±æ€§

æœŸé—´è®¾è®¡dllåŸºå€å¯»æ‰¾,PEèŠ‚åŒºçš„éå†

ä¿®æ”¹æŸæ®µèŠ‚åŒºå±æ€§ç­‰ç­‰å§

å†…å­˜åˆ›å»ºä»€ä¹ˆçš„

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled17.png)

ç›®æ ‡èŠ‚åŒºå¯»æ‰¾å’Œä¿®æ”¹å±æ€§

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled18.png)

å¯è¯»å¯å†™å¯æ‰§è¡Œ

`sub_1800018B0(ntdll_text_self, ntdll_text_new, VirtualSize);` ä¸çŸ¥é“å¹²äº†ä»€ä¹ˆ

åæ­£ `ntdll_text_self, ntdll_text_new` æŒ‡å‘çš„å†…å­˜æ²¡å‘ç”Ÿæ”¹å˜



å…¶å®åæ¥çœ‹æ–‡ç« å‘ç°

ä»–å…¶å®æ˜¯åœ¨è„±é’©unhoook

æŠŠåŸæ¥çš„ntdllå¤åˆ¶ä¸€ä»½è¦†ç›–è¿œç¨‹è¿›ç¨‹çš„é‚£ä¸ªntdll

è¿™æ ·å°±è„±å»äº†è¿œç¨‹è¿›ç¨‹TapiUnattendçš„é’©å­

## shellcode.2

æŸ¥èµ„æ–™è¯´,ä»–æ˜¯ä¸€ä¸ªæœ¨é©¬

ç»è¿‡åˆ†æåå¾—çŸ¥,å…¶å®ä»–ä¹Ÿæ˜¯ä¸€ä¸ªpeloadå’Œdllæ–‡ä»¶çš„ç»“åˆä½“

pelodeå®Œæˆdllæ–‡ä»¶çš„åˆå§‹åŒ–å,å°±å»æ‰§è¡Œdllçš„entrypoint

åˆ†æèµ·æ¥æ¯”ä¸Šä¸€å„¿è¦è´¹åŠ²äº›

### PEåŠ è½½å™¨åˆ†æ

ä¸€å¼€å§‹,å¯»æ‰¾è‡ªå·±çš„åŸºåœ°å€

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled19.png)

ç„¶åå¯»æ‰¾kernel32çš„åŸºåœ°å€

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled20.png)

ç„¶ååˆå§‹åŒ–åŸºæœ¬çš„å‡ ä¸ªAPIåœ°å€

![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled21.png)

ç„¶åå°±æ˜¯è°ƒç”¨è¿™äº›æ‰¾åˆ°çš„APIå»åŠ è½½PEæ–‡ä»¶

å…·ä½“ä¸ä¸å±•ç¤º,è¯´ä¸€ä¸‹æµç¨‹

peå¤´å¤åˆ¶

èŠ‚åŒºå¤åˆ¶

å¯¼å…¥è¡¨åˆå§‹åŒ–: åˆ†ä¸º2æ­¥.dllåŠ è½½å’ŒIATå¡«å…… , Atå¡«å……åˆ†2ç§æƒ…å†µ,,,IDå¯¼å…¥å’Œå­—ç¬¦ä¸²å¯¼å…¥

ps: å¯¼å…¥è¡¨çš„dllåå­—å’Œå‡½æ•°åå­—éƒ½è¢«å¼‚æˆ–åŠ å¯†äº†,è§£å¯†ä¹‹åæ‰æ“ä½œçš„

åŸºå€é‡å®šä½

ç„¶åå»å¾€eipæ‰§è¡Œ



å…¶å®åœ¨è¿™é‡Œ,å°±äº§ç”Ÿäº†ä¸€äº›é—®é¢˜,é‚£å°±æ˜¯ä»–çš„å¯¼å…¥è¡¨è¡¨æ˜¯è¢«åŠ å¯†äº†çš„

å¦‚æœæˆ‘æŠŠshellcodeç»™dumpå‡ºæ¥å,IDAåç¼–è¯‘æ˜¯æœ‰é—®é¢˜çš„

ä½†å‡¡æ¶‰åŠå¯¼å…¥è¡¨çš„å‡½æ•°,IDAå°±ç¿»è¯‘gäº†

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªæ ·å­

![image-20230721005304481](img/image-20230721005304481.png)

é‚£äº›`____`çš„ä¸œä¸œ,å…¶å®IDAæ²¡æœ‰ä»å¯¼å…¥è¡¨æˆåŠŸåŠ è½½çš„å‡½æ•°

æ‰€ä»¥è¦è¿›è¡Œä¸‹ä¸€æ­¥åˆ†æçš„è¯

éœ€è¦è§£å¯†å¯¼å…¥è¡¨

è§£å¯†è„šæœ¬è§resæ–‡ä»¶å¤¹

è§£å¯†ä¹‹åå¦‚å›¾,å°±ä¼šéå¸¸æ¸…æ™°



![image-20230721010314287](img/image-20230721010314287.png)

è¿™åŒæ—¶ä¹Ÿå‘Šè¯‰æˆ‘ä»¬ä¸€ä¸ªé“ç†,åŠ å¯†å¯¼å…¥è¡¨åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ˜¯å¯ä»¥å¹²æ‰°IDAé™æ€åˆ†æçš„

å…¶å®å¯¹åŠ¨æ€åˆ†æä¹Ÿæœ‰ä¸€å®šçš„å¹²æ‰°ç¨‹åº¦



å…¶ä¸­,æœ‰ç‚¹å¾ˆå¥‡æ€ª

é‚£å°±æ˜¯å…³äºå†…å­˜å¼€è¾Ÿè¿™ä¸ªä¸œè¥¿

æ¯”å¦‚æˆ‘ä»¬æŠŠä¸€ä¸ªpeæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­

0~0x1000è¿™æ®µç©ºé—´è™½ç„¶æ˜¯peå¤´æ‰€æ‹¥æœ‰,ä½†æ˜¯åœ¨è¿è¡Œçš„æ—¶å€™,ä¸€èˆ¬ä¸ä¼šè®¿é—®è¿™ä¸ªåŒºåŸŸçš„æ•°æ®





### dllæ–‡ä»¶åˆ†æ

åœ¨peåŠ è½½çš„æ—¶å€™å°±å·²ç»è¿›è¡Œäº†ä¸€ä¸ªEntryPointçš„å‰å¾€

é‚£æ—¶è¿›è¡Œäº†ä¸€ä¸ªdllçš„åˆå§‹åŒ–

ç¬¬äºŒæ¬¡è¿›å…¥çš„æ—¶å€™,dwReason=4

å¾ˆå¥‡æ€ª,ä¸€èˆ¬æ¥è¯´éƒ½æ˜¯0,1,2,3,

ä½†æ˜¯é€šè¿‡åé¢åˆ†æ,å…¶å®4-1äº†,ç»“æœæ˜¯3

![image-20230721011612760](img/image-20230721011612760.png)



#### å¦‚ä½•åˆ†æ

åé¢æˆ‘é€šè¿‡äº†å¾ˆå¤šç§æ–¹å¼å»åˆ†æshellcode2çš„dll

æ¯”å¦‚

1),æŠŠshellcodeæ”¾å…¥ä¸€ä¸ªæ–°çš„èŠ‚åŒº,ç„¶åexeå»å¾€é‚£ä¸ªèŠ‚åŒºåŠ è½½å¹¶æ‰§è¡Œdllç›¸å…³ä¸œè¥¿

ä¸è¶³: æ˜¯ç”¨API monitor æ— æ³•ç›‘è§†,å®ƒåªèƒ½ç›‘è§†é‚£ç§ä¸­è§„ä¸­çŸ©çš„æ–‡ä»¶

2), æŠŠshellcodeæå–ä¸ºä¸€ä¸ªdll,ç„¶åæŠŠLoadLibaryåŠ è½½,æ•ˆæœè¿˜æ˜¯ä¸ç†æƒ³,å¹¶ä¸” API monitorä¹Ÿæ— æ³•ç›‘è§†

3), æŠŠshellcodeæå–ä¸ºä¸€ä¸ªdll,ç„¶åå†™å…¥å¯¼å…¥è¡¨,ç„¶åç”¨windwosåŠ è½½,ç„¶åæˆ‘ä»¬åœ¨ç¨‹åºçš„epé‚£é‡Œå†æ¬¡å»å¾€dll

é™„å¸¦å¦å¤–ä¸€ä¸ªReason

![image-20230722000425979](img/image-20230722000425979.png)

å°±è¿™æ ·,ä¸»ç¨‹åºå†æ¬¡å»å¾€ep

æœŸé—´ä¹Ÿé‡åˆ°å¾ˆå¤šæ— æ³•è§£å†³çš„é—®é¢˜

æ¯”å¦‚ç”¨getModuleHandleè·å–dllçš„åŸºåœ°å€,è€Œä¸æ˜¯å†™æ­»åŸºåœ°å€, å‘ç°åé¢è«åå…¶å¦™å¼‚å¸¸

åªèƒ½æŠŠåœ°å€å†™æ­»,ç„¶åå»å¾€dll



#### API monitor 



ä¿¡æ¯çªƒå–?

![image-20230722112312453](img/image-20230722112312453.png)



ä»–ä¼šè·å–æˆ‘ä»¬çš„ç”¨æˆ·å,ç”µè„‘åå­—,IPåœ°å€

![image-20230722114347323](img/image-20230722114347323.png)

åé¢å‘¢å°±æ— æ³•åˆ†æäº†,å› ä¸ºç¨‹åºä¸è·‘äº†



# æº¯æº



![image-20230722121625844](img/image-20230722121625844.png)





![Untitled](./img/09bcc9fd2be4416183d6a2fd50831dd5Untitled22.png)





![image-20230722122835265](img/image-20230722122835265.png)



![image-20230722124622683](img/image-20230722124622683.png)

# èµ„æºæ–‡ä»¶



bad.dll :ç¬¬1ä¸ªshellcodeçš„æå–ç‰©

bad2.dll ç¬¬2ä¸ªshellcodeçš„æå–ç‰©è´¨

bad2.dll.fixed å¯¼å…¥è¡¨è§£å¯†åçš„dll

bad3.dll åŒbad2.dll.fixed

C1.exe_ è‡ªåŠ¨åŠ è½½bad3.dll

Load_sec1.exe_ æŠŠshellcode1æ”¾å…¥è‡ªå·±çš„èŠ‚åŒºå¹¶æ‰§è¡Œ

Load_sec2.exe_ æŠŠshellcode2æ”¾å…¥è‡ªå·±çš„èŠ‚åŒºå¹¶æ‰§è¡Œ

Load_sec2:ä¸»è¦æ˜¯ç ”ç©¶ç¬¬2ä¸ªdll.æ”¾å…¥è‡ªå·±çš„èŠ‚åŒºæ‰§è¡Œ

Loader_me: åŠ è½½bad3.dll,ç„¶åepå»å¾€bad3.dll