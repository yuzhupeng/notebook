

# å…³äºæœ¬èŠ‚

å¾ˆå¤šä¸œè¥¿è§†é¢‘æ²¡æœ‰è®²æ˜ç™½

è¯´ä¸€å®éªŒä»€ä¹ˆçš„ä¹Ÿä¸å¥½åš





å¯¹äºTSSçš„å¦‚ä½•æ¢æ‰ä¸€å †å¯„å­˜å™¨æ˜¯æ€ä¹ˆå®ç°çš„?ä¸çŸ¥é“

å¯¹äºtrå¯„å­˜å™¨æ˜¯å¦‚ä½•ä¿®æ”¹çš„,,,ä¸çŸ¥é“

å¯¹äºldtæ˜¯å¹²å˜›çš„,,,ä¸çŸ¥é“

ldtræ˜¯å¹²å˜›çš„,,ä¹Ÿä¸çŸ¥é“





# å‰è¨€

å› ä¸ºæ€§èƒ½çš„ä¸€äº›åŸå› 

TSSåœ¨x64ä¸‹å·²ç»ä¸å†ä½¿ç”¨çš„

ä¸è¦æŠŠTSSå’Œä»»åŠ¡åˆ‡æ¢è”ç³»åˆ°ä¸€èµ·

TSSçš„æ„ä¹‰åœ¨äºåŒæ—¶æ¢æ‰ä¸€å †å¯„å­˜å™¨



TSS (Task-state segment )ï¼šä»»åŠ¡çŠ¶æ€æ®µ 

åœ¨è°ƒç”¨é—¨ã€ä¸­æ–­é—¨ä¸é™·é˜±é—¨ä¸­ï¼Œä¸€æ—¦å‡ºç°æƒé™åˆ‡æ¢ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å †æ ˆçš„åˆ‡æ¢ï¼›

æ‰€ä»¥å°±ä¼šå‡ºç°SS,SPçš„åˆ‡æ¢,é‚£ä¹ˆåˆ‡æ¢éœ€è¦çš„SS,SPåˆå§‹åŒ–çš„æ•°æ®æ¥è‡ªå“ªé‡Œå‘¢? æ¥è‡ªTSSä»»åŠ¡çŠ¶æ€æ®µ





TRæ˜¯ä¸€ä¸ª16ä½çš„å¯„å­˜å™¨,å­˜å‚¨äº†æ®µé€‰æ‹©å­,

é‚£ä¸ªæ®µé€‰æ‹©å­æŒ‡å‘çš„å°±æ˜¯TSSæ®µæè¿°

TSSæ®µæè¿°åˆæŒ‡å‘ä¸€ä¸ªè‡³å°‘104å­—èŠ‚çš„å†…å­˜,è¯¥å†…å­˜å­˜å‚¨äº†çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ



LDTRæŒ‡å‘çš„æ˜¯LDTæè¿°ç¬¦,,LDTæè¿°ç¬¦ä½äºGDTä¸­



# TRå¯„å­˜å™¨

TRå¯„å­˜å™¨å‘Šè¯‰äº†TSSçš„æ®µæè¿°ç¬¦

ä¹Ÿå°±æ˜¯ä½äºGDTçš„å“ªé‡Œ





## å†™TRå¯„å­˜å™¨



æŒ‡ä»¤ï¼š`LTR`

åœ¨R0å¯ä»¥é€šè¿‡LTRæŒ‡ä»¤ä¿®æ”¹TRæ®µå¯„å­˜å™¨ã€‚

è¯´æ˜ï¼š

1.  ç”¨LTRæŒ‡ä»¤å»è£…è½½çš„è¯ ä»…ä»…æ˜¯æ”¹å˜TRå¯„å­˜å™¨çš„å€¼(96ä½)
2.  å¹¶æ²¡æœ‰çœŸæ­£æ”¹å˜TSS
3.  LTRæŒ‡ä»¤åªèƒ½åœ¨ç³»ç»Ÿå±‚ä½¿ç”¨
4.  åŠ è½½åTSSæ®µæè¿°ç¬¦çš„çŠ¶æ€ä½ä¼šå‘ç”Ÿæ”¹å˜

åœ¨R3å¯ä»¥é€šè¿‡ CALL FAR æˆ–è€… JMP FAR æŒ‡ä»¤ä¿®æ”¹ã€‚



ç”¨JMPå»è®¿é—®ä¸€ä¸ªä»£ç æ®µçš„æ—¶å€™ï¼Œæ”¹å˜çš„æ˜¯CSå’ŒEIPï¼š

JMP 0x48:0x123456ï¼Œå¦‚æœ0x48æ˜¯ä»£ç æ®µï¼Œæ‰§è¡Œåï¼šCS->0x48ã€EIP->0x123456ã€‚

ç”¨JMPå»è®¿é—®ä¸€ä¸ªä»»åŠ¡æ®µçš„æ—¶å€™ï¼š

å¦‚æœ0x48æ˜¯TSSæ®µæè¿°ç¬¦ï¼Œå…ˆä¿®æ”¹TRæ®µå¯„å­˜å™¨ï¼Œå†ç”¨TR.BASEæŒ‡å‘çš„TSSä¸­çš„å€¼ä¿®æ”¹å½“å‰çš„å¯„å­˜å™¨ã€‚



##  è¯»TRå¯„å­˜å™¨



æŒ‡ä»¤ï¼š`STR`

è¯´æ˜ï¼šå¦‚æœç”¨STRå»è¯»çš„è¯ï¼Œåªè¯»äº†TRçš„16ä½ï¼Œä¹Ÿå°±æ˜¯æ®µé€‰æ‹©å­



ç›¸å…³å®éªŒæ²¡åš,æ²¡æœ‰ç¯å¢ƒ

# TSS





>   å¼•å…¥

TSSåœ¨å“ªé‡Œ?

```c++
0: kd> r gdtr
gdtr=8003f000
0: kd> dq 8003f000
8003f000  00000000`00000000 00cf9b00`0000ffff
8003f010  00cf9300`0000ffff 00cffb00`0000ffff
8003f020  00cff300`0000ffff 80008b04`200020ab
8003f030  ffc093df`f0000001 0040f300`00000fff
8003f040  0000f200`0400ffff 00000000`00000000
8003f050  80008955`27000068 80008955`27680068
8003f060  00009302`2f40ffff 0000920b`80003fff
8003f070  ff0092ff`700003ff 80009a40`0000ffff
0: kd> r tr
tr=00000028
```

TRå¯„å­˜å™¨ä¼šå‘Šè¯‰ä½ ,TRå°±æ˜¯ä¸€ä¸ªåŸºäºWORDç±»å‹çš„æ®µé€‰æ‹©å­

TSSæ˜¯ä¸€å—å†…å­˜,æ¯ä¸€ä¸ªTSSéƒ½å­˜å‚¨äº†ä¸ä¹‹å¯¹åº”çº¿ç¨‹çš„ä¸Šä¸‹æ–‡

å¤§å°ï¼šè‡³å°‘104å­—èŠ‚

![img](./img/taskgate.png)

å¦å¤–TRå¯„å­˜å™¨æ˜¯å›ºå®šä¸å˜çš„,æ— è®ºå¦‚ä½•è¿›è¡Œä¸€ä¸ªçº¿ç¨‹åˆ‡æ¢,TRéƒ½ä¸ä¼šå‘ç”Ÿæ”¹å˜

å˜çš„æ˜¯ä»€ä¹ˆ?æ˜¯TRå¯„å­˜å™¨æŒ‡å‘çš„TSSå†…å­˜

ç„¶åå†…å­˜é‡Œé¢çš„ESPæˆå‘˜ä¸€ç›´åœ¨å˜,,å…¶å®ƒå¤§å¤šæ•°æˆå‘˜éƒ½æ²¡æœ‰å‘ç”Ÿæ”¹å˜

é‚£ä¹ˆæ¯ä¸€ä¸ªçº¿ç¨‹çš„TSSçš„ESPæ¥è‡ªå“ªé‡Œ?

ç­”:æ¯ä¸€ä¸ªçº¿ç¨‹çš„`_KPCR`



Intelçš„è®¾è®¡æ€æƒ³ï¼šåœ¨æ“ä½œç³»ç»Ÿè¿è¡Œçš„æ—¶å€™ï¼Œè¿›è¡Œä»»åŠ¡çš„åˆ‡æ¢ã€‚

Intelæåˆ°çš„ä»»åŠ¡å¯¹åº”çš„æ˜¯æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ã€‚

å®ƒåœ¨CPUå±‚é¢å«ä»»åŠ¡ï¼Œ

æ“ä½œç³»ç»Ÿå±‚é¢å«çº¿ç¨‹ã€‚

å½“ç¨‹åºæ‰§è¡Œçš„æ—¶å€™ï¼Œå¦‚æœæƒ³åšæ–°çš„äº‹æƒ…ï¼Œæˆ–è€…æ–°çš„ä»»åŠ¡ï¼Œ

é‚£ä¹ˆä¸Šä¸‹æ–‡ç¯å¢ƒéœ€è¦å‘ç”Ÿå˜åŒ–ï¼Œä¸èƒ½ä½¿ç”¨åŸæ¥çš„å¯„å­˜å™¨ã€‚

åŸæ¥çš„å¯„å­˜å™¨å­˜å‚¨çš„æ˜¯ä¸Šä¸€ä¸ªç¨‹åºè¦ç”¨åˆ°çš„å€¼ã€‚

å¦‚æœè¦åšæ–°çš„äº‹æƒ…ï¼Œé‚£è‚¯å®šè¦æ–°çš„å¯„å­˜å™¨ï¼Œ

é‚£ä¹ˆæ–°çš„å¯„å­˜å™¨ä»å“ªæ¥å‘¢ï¼ŸTSSã€‚

å½“æƒ³è¦æ¢å¤åŸæ¥çš„äº‹æƒ…ï¼Œåªéœ€è¦æŠŠåŸæ¥çš„å¯„å­˜å™¨çš„å€¼å­˜åˆ°TSSä¸­ï¼Œ

é€šè¿‡TSSå†å†™å…¥å¯„å­˜å™¨ä¸­å°±æ¢å¤åŸæ¥çš„æ ·å­äº†ã€‚

æ‰€è°“çš„ä»»åŠ¡åˆ‡æ¢ï¼Œå…¶å®å°±æ˜¯çº¿ç¨‹åˆ‡æ¢ã€‚


ä¸è¦æŠŠTSSä¸ "ä»»åŠ¡åˆ‡æ¢" è”ç³»åˆ°ä¸€èµ·ã€‚

TSSçš„æ„ä¹‰å°±åœ¨äºå¯ä»¥åŒæ—¶æ›¿æ¢æ‰ "ä¸€å †" å¯„å­˜å™¨ï¼Œä»…æ­¤è€Œå·²ã€‚







# TSSæ®µæè¿°ç¬¦



![img](./img/tss.png)



```c++
(80008955`87000068)
80558700->æ‹¿åˆ°çš„åœ°å€
```







å’Œå¸¸è§„çš„å·®ä¸å¤š



Type = äºŒè¿›åˆ¶1001ï¼šè¯´æ˜è¯¥TSSæ®µæè¿°ç¬¦**æœª**è¢«åŠ è½½åˆ°TRæ®µå¯„å­˜å™¨ä¸­

Type = äºŒè¿›åˆ¶1011ï¼šè¯´æ˜è¯¥TSSæ®µæè¿°ç¬¦**å·²**è¢«åŠ è½½åˆ°TRæ®µå¯„å­˜å™¨ä¸­



![image-20230912081102280](./img/image-20230912081102280.png)





<div style="color:#00CED1;font-size:16px">
   	æ³¨æ„ï¼š<br>
   	é«˜4å­—èŠ‚çš„ç¬¬23ä½ï¼Œä¹Ÿå°±æ˜¯Gä½ã€‚<br>
   	Gä½=0ï¼šä»£è¡¨limitç•Œé™å•ä½æ˜¯å­—èŠ‚<br>
   	Gä½=1ï¼šä»£è¡¨limitç•Œé™å•ä½æ˜¯4KBã€‚<br>
	å‰æ–‡ä¸­çš„å®éªŒé€šå¸¸éƒ½æ˜¯1ï¼Œæœ¬æ–‡ä¸­ä¸º0ã€‚<br>
	ä¸ºä»€ä¹ˆæ˜¯0ï¼Ÿå› ä¸ºLIMITæŒ‡å‘çš„TSSæ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½çš„ã€‚<br>
</div>






# ä»»åŠ¡é—¨



![image-20230116235203649](./img/image-20230116235203649.png)

ä¿ç•™éƒ¨åˆ†,éšæ„å†™

![](./img/d3.png)



ä»»åŠ¡é—¨ä½äºIDTè¡¨

è€Œä¸æ˜¯GDTè¡¨ä¸­



INT Nï¼ˆNä¸ºIDTè¡¨ç´¢å¼•å·ï¼‰

ç³»ç»Ÿé€šè¿‡ç”¨æˆ·æŒ‡å®šçš„ç´¢å¼•æŸ¥æ‰¾IDTè¡¨ï¼Œæ‰¾åˆ°å¯¹åº”çš„é—¨æè¿°ç¬¦

é—¨æè¿°ç¬¦è‹¥ä¸ºä»»åŠ¡é—¨æè¿°ç¬¦ï¼Œåˆ™æ ¹æ®ä»»åŠ¡é—¨æè¿°ç¬¦ä¸­TSSæ®µé€‰æ‹©å­æŸ¥æ‰¾GDTè¡¨ï¼Œæ‰¾åˆ°TSSæ®µæè¿°ç¬¦

å°†TSSæ®µæè¿°ç¬¦ä¸­çš„å†…å®¹åŠ è½½åˆ°TRæ®µå¯„å­˜å™¨

TRæ®µå¯„å­˜å™¨é€šè¿‡Baseå’ŒLimitæ‰¾åˆ°TSS

ä½¿ç”¨TSSä¸­çš„å€¼ä¿®æ”¹å¯„å­˜å™¨

IRETDè¿”å›

ç›¸å…³å®éªŒæ²¡åš,æ²¡ç¯å¢ƒ



# å®éªŒ

è¿™äº›å®éªŒ,,,,åŸºæœ¬ä¸Šçœ‹ç½‘ä¸Šçš„ä¹Ÿæ²¡æœ‰ä½œå¯¹,,,ğŸ˜”

ä»¥åå›å¤´å†æ¥çœ‹çœ‹å‘—



å¦å¤–è¿™ä¸ªå®éªŒå¥½åƒå‘å¾ˆå¤šçš„

å¾ˆå¤šåœ°æ–¹è¦æ³¨æ„çš„



å…¶ä¸­è§†é¢‘

\ä¿æŠ¤æ¨¡å¼\16.ä»»åŠ¡æ®µä¸‹

\ä¿æŠ¤æ¨¡å¼\17-101012åˆ†é¡µæœºåˆ¶

éƒ½æ˜¯å­¦ç”Ÿæ¼”ç¤ºè¿™äº›å®éªŒ,,,ç„¶åè€å¸ˆå¹¶æ²¡æœ‰è®²è§£ä»€ä¹ˆçš„



## call ä»»åŠ¡é—¨



```c++
#include <stdio.h>
#include <stdlib.h>
#include <windows.h>

char trs[6]={0};
char gdts[6]={0};



void __declspec(naked)  test()
{
        __asm
        {
            int 3;
            push eax;
            pushfd;
            pop eax;
            or eax,0x4000;
            push eax;
            popfd;
            pop eax;
            //jmp fword ptr trs;
            iretd;
        }
}

int main(int argc,char * argv[])
{

    char stack[100]={0};
    DWORD cr3=0;
    char buf[6]={0,0,0,0,0x48,0};
    DWORD st_tss[0x68]={
            0x0,0x0,0x0,0x0,
            0x0,0x0,0x0,
            cr3,//cr3
            (DWORD)test,//eip
            0,//eflag
            0,//eax
            0,//ecx
            0,//edx
            0,//ebx
            ((DWORD)stack) - 100,//esp
            0,//ebp
            0,//esi
            0,//edi
            0x23,//es
            0x08,//cx
            0x10,//ss
            0x23,//ds
            0x30,//fs
            0,//gs
            0,//ldt
            0x20ac0000//xx?

    };
    WORD rs=0;
    printf("cr3:");
    scanf("%X",&cr3);
    _asm{
        sgdt gdts;
        str ax;
        mov rs,ax;
    }
    *(WORD*)&trs[4]=rs;
    printf("%X\n",&st_tss);
    system("pause");
    __asm
    {
        call fword ptr buf;
    }
    printf("hi you get here\n");
    return 0;
}
```









é¦–å…ˆæ„é€ TSS

```c++
|         (00cfbb00`0000ffff)
|         (00000000)[0,000FFFFF)        |
|---------------------------------------|
| TYPE | S | DPL | P | AVL | - | DB | G |
| 1101 | 1 | 10  | 1 | 0   | 0 | 1  | 1 |
|---------------------------------------|
```



## jmp ä»»åŠ¡é—¨



jmpè¿‡å»,ä¸ä¼šNt=1

```c++
#define  _CRT_SECURE_NO_WARNINGS
#include <stdio.h>
#include <stdlib.h>
#include <Windows.h>
char trs[6]={0};
char gdts[6]={0};

void __declspec(naked)  test()
{
	__asm
	{
		int 3;
		jmp fword ptr trs;
		//iretd;
	}
}

int main(int argc,char * argv[])
{
	char stack[100]={0};
	DWORD cr3=0;
	WORD rs=0;
	char buf[6]={0,0,0,0,0x48,0};
	DWORD tss[0x68]={
		0x0,
		0x0,
		0x0,
		0x0,
		0x0,
		0x0,
		0x0,
		cr3,
		(DWORD)test,
		0,
		0,
		0,
		0,
		0,
		((DWORD)stack) - 100,
		0,
		0,
		0,
		0x23,//es
		0x1b,//cs
		0x23,//ss
		0x23,//ds
		0x30,//fs
		0,//gs
		0,
		0x20ac0000
	};

	printf("cr3:");
	scanf("%X",&cr3);
	tss[7]=cr3;
	printf("%x\n",&tss);
	system("pause");
	_asm
	{
		sgdt gdts;
		str ax;
		mov rs,ax;
	}
	*(WORD*)&trs[4]=rs;
	__asm
	{
		jmp fword ptr buf;
	}
	printf("wow you got here\n");
	return 0;
}
```

