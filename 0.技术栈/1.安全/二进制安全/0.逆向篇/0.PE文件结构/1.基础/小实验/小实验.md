# 小实验

# 给dll增加一个函数

## 结构体

dll中有些函数没有导出,而留在了内部使用

所以如果要提取出来并使用,就需要我们手动修改导出表的一些信息

```
 struct _IMAGE_EXPORT_DIRECTORY
 {
     DWORD   Characteristics;//未使用 导出表的特征标志，一般为0
     DWORD   TimeDateStamp;//时间戳 导出表的创建时间戳。
     WORD    MajorVersion;//未使用 导出表的主版本号
     WORD    MinorVersion;//未使用 导出表的次版本号。

     DWORD   Name;//字符串指针 dll的名字
     DWORD   Base;//基址编号 导出表中所有函数的序号起始值，默认为1
     DWORD   NumberOfFunctions;// 导出表中的导出函数数量,其中是有空函数的
     DWORD   NumberOfNames;// 导出表中有字符串名称的导出函数数量
     DWORD   AddressOfFunctions;// dword数组, 实际函数的RvA数组 导出表中所有导出函数
     DWORD   AddressOfNames;// dword数组 导出表中所有有名称的导出函数的名称
     DWORD   AddressOfNameOrdinals;// word数组  导出表中所有有名称的导出函数序号
 } IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;
```

注意导出表大小只的是所有数据的总和

而不是单单指cnt*sizeof(struct _IMAGE_EXPORT_DIRECTORY )

同时还包括了AddressOfFunctions[], AddressOfNames[] AddressOfNameOrdinals[] 数组的总大小

## 导出表的布局

另外说一下导出表的布局

显示导出表结构体

![Untitled](%E5%B0%8F%E5%AE%9E%E9%AA%8C%206ea4afe7d14a48a4b317099289203f42/Untitled.png)

然后是这几个数组挨着的

```
 DWORD   AddressOfFunctions;     // dword数组, 实际函数的RvA数组 导出表中所有导出函数
 DWORD   AddressOfNames;         // dword数组 导出表中所有有名称的导出函数的名称
 DWORD   AddressOfNameOrdinals
```

AddressOfFunctions

![Untitled](%E5%B0%8F%E5%AE%9E%E9%AA%8C%206ea4afe7d14a48a4b317099289203f42/Untitled%201.png)

AddressOfName

![Untitled](%E5%B0%8F%E5%AE%9E%E9%AA%8C%206ea4afe7d14a48a4b317099289203f42/Untitled%202.png)

AddressOfNameOrdinals

![Untitled](%E5%B0%8F%E5%AE%9E%E9%AA%8C%206ea4afe7d14a48a4b317099289203f42/Untitled%203.png)

Name

![Untitled](%E5%B0%8F%E5%AE%9E%E9%AA%8C%206ea4afe7d14a48a4b317099289203f42/Untitled%204.png)

functionName

![Untitled](%E5%B0%8F%E5%AE%9E%E9%AA%8C%206ea4afe7d14a48a4b317099289203f42/Untitled%205.png)

所以的话,你可以不修改对应的导出表,但是你要连续的移动

Name的字符串

AddressOfFunctions

AddressOfNameOrdinals

AddressOfNames

functionName

所以总结如下 修改部分:

为AddressOfFunctions[]增加成员,占位为0xffffffff,后面数据后移

为AddressOfNames[]增加成员,占位为0xffffffff,后面数据后移

为AddressOfNameOrdinals[]增加成员,占位为0xffff(word) 后面数据后移

然后给0xffffffff填充数据

修改NumberOfFunctions,NumberOfNames

修改AddressOfFunctions,AddressOfNames,AddressOfNameOrdinals指向的位置

修改导出表的地址,大小 (看情况修改)

ps:虽然没有给出具体的图示步骤,但是按照如上的步骤,还是很容易添加一个函数的