如果**双击**运行被查杀，则为 **动态查杀** 

如果**放置进杀软环境**被查杀则**可能 动态查杀**



动态查杀同样分为两种查杀，一种为指定类型查杀，一种为未知类型查杀。



**指定类型查**: 例如，某数字查杀cobaltstrike等知名远控则是通过shell code内存匹配来进行查杀。

**未知病毒查杀-启发式查杀和主动防御**

杀软通过拦截程序运行的api调用，通过api序列，或其是否高危来判定是否为病毒。

举几个例子，

1.Kas针对cobaltstrike的查杀是通过联网URL的地址特征，进行查杀。

2.通过将Dll拷贝到磁盘后，会被沙箱进行行为分析。例如，Dll下载者会被查杀，很明显DLL是没办法直接双击运行，但某些杀软依旧会查杀。

3.注入explorer.exe直接被干掉。

4.Bitdexxxxx会在运行时查杀空壳且名字随机的1.exe,asd.exe，干扰免杀。

主动防御有的杀软会在断网模式不开启该功能,比如云沙盒测试需要联网







# 虚拟机查杀

## 虚拟机的功能

(1)x86指令仿真

(2)Windows运行环境仿真

​	API仿真
​	Windows异常仿真
​	Windows核心内存结构仿真



## 虚拟机的目的

(1)自动脱壳 

(2)做动态启发式查杀

动态识别敏感API序列(动态API检测)

### 行为序列检测

```
创建进程枚举进程列表 结束进程枚举 AV进程窗口
释放PE文件提升权限注册全局消息钩子 拷贝自己到系统目录
添加启动项加载驱动加载服务
修改服务模块信息联网下载安装 SPI(Services Provider Interface)
注册组件注入远程线程改写其他进程内存
操作SFC(System File Checker)修改文件关联
修改IE的- -些默认配置(主页,搜索引|擎等)枚举局域网资源
添加防火墙应用程序规则操作 MBR
```



### 敏感行为检测

结束AV进程修改AV的注册表

占位一些AV软件的互斥体(如创建AVP的互斥对象)

添加针对AV的IFEO卸载其他进程的主模块 禁止 Windows安全中心的一-些项目

一些明显的 Anti-AV的手段(此如注册表路径中含有#字符)禁止运行任务管理器

向AV软件窗口发送特定的消息修改 IE下载文件控制属性



### 捕获执行中的怪异点

非法使用句柄

访问特殊内存区间的访问

TEB , PEB中的某些字段访问 USER_ SHARED_ DATA内存区域

直接使用偏移来调用API





## 对抗虚拟机查杀

### 判断执行环境

判断父进程ID是否是Explorer

ps： 有时杀软也可能故意指定为Explorer

判断运行基地址是否是加载基地址

使用虚拟机未模拟的API

### 执行未模拟的指令

使用HASH值代替API名

使用重映射引入的API

## Anti-Heuristic的感染方式的详细流程



所需模块

>启动EXE模板程序

在编译膜拜程序时,将EXE程序的基地址设置为0
简单的PE加载器
一套加解密算法
其他恶意功能



> PE加载器的DLL

复杂的PE加载器
修复TLS数据.
重映射DLL
-套加解密算法
其他恶意功能



> 打包程序

扩展末尾节大小
可以直接对处于文件状态的PE文件做重定位操作



## 重要的流程

> 打包程序的运行流程

从要保护的恶意程序中取出它的基地址(A)
计算恶意程序的内存对齐后的大小(X)
获取PE加载器DLL的文件大小
为PE加载器DLL添加一个新节,使用X为大小
将被保护的程序放置到以上的新节内(加密)生成了新的PE加载器DLL
直接在模板EXE文件上进行重定位基地址为A
扩展模板EXE文件的重定位节(末尾)的大小为新的PE加载器DLL
将新的PE加载器DLL复写到模板EXE的重定位节中(加密)
设置模板EXE为DEP不兼容,重新计算PE校验和等辅助操作



> 被免杀后运行的流程

模板EXE程序启动
模板EXE程序从重定位节中解密并取出PE加载器DLL
模板EXE程序从重定位节中解密并取出PE加载器DLL
PE加载器DLL启动后，从自身末尾新节内解密原来被免杀的程序
PE加载把这个程序加载到模板EXE程序内,并跳入到原始入口点执行