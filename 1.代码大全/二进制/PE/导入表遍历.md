



# x64



```c
#include <windows.h>
#include <stdio.h>


PIMAGE_SECTION_HEADER gSectionHeader;
PIMAGE_NT_HEADERS64 gNtheader;
DWORD64 gFilesize;
BYTE gxorValue;
BYTE* gfileBase;

//显示导入表
void showImport()
{
	//dll名字
	int i, j, k;
	DWORD32 imagebase = gNtheader->OptionalHeader.ImageBase;
	PIMAGE_IMPORT_DESCRIPTOR lpImport = VA2FA(gNtheader->OptionalHeader.DataDirectory[1].VirtualAddress) + gfileBase;
	PIMAGE_IMPORT_BY_NAME byname;
	DWORD64* IAT;
	DWORD64* INT;
	BYTE* DllName;
	BYTE* APIName;
	
	HMODULE hDll;

	PIMAGE_NT_HEADERS64 gNtheader_Dll;
	PIMAGE_EXPORT_DIRECTORY lp_Export_Dll;
	DWORD* AddressOfNames;
	WORD* AddressOfNameOrdinals;
	WORD IDbase;
	int numFunc;
	if (gNtheader&&gNtheader->OptionalHeader.DataDirectory[1].VirtualAddress == 0)
	{
		return;
	}
	for (i = 0; lpImport[i].Name; i++)
	{
		DllName = (char*)(VA2FA(lpImport[i].Name) + gfileBase);
		for (k = 0; ; k++)
		{
			DllName[k]^= gxorValue;
			if ( (DllName[k + 1] ^ gxorValue) == 0)
			{
				DllName[k+1] ^= gxorValue;
				break;
			}
		}
	 

		printf("%s\n", DllName);
		hDll = LoadLibraryA(DllName);
		if (1)
		{
			INT = VA2FA(lpImport[i].OriginalFirstThunk) + gfileBase;
			
			for (j = 0; INT[j]; j++)
			{
				if ( INT[j] && ((INT[j] >> 63) == 1))//ID导入
				{
					
					if (hDll)
					{
						gNtheader_Dll = (*(DWORD*)((BYTE*)hDll + 0x3c)) + (BYTE*)hDll;
						lp_Export_Dll = gNtheader_Dll->OptionalHeader.DataDirectory[0].VirtualAddress + (BYTE*)hDll;
						AddressOfNames = lp_Export_Dll->AddressOfNames + (BYTE*)hDll;
						AddressOfNameOrdinals = lp_Export_Dll->AddressOfNameOrdinals + (BYTE*)hDll;
						IDbase = lp_Export_Dll->Base;
						numFunc = lp_Export_Dll->NumberOfFunctions;
						for (k = 0; k < numFunc; k++)
						{
							if ((INT[j] & 0xffff) == AddressOfNameOrdinals[k])
							{
								break;
							}
						}
						if (k != numFunc)
							printf("	%s\n", AddressOfNames[k - IDbase] + (BYTE*)hDll);

					}
					//API_get = hDll+ *(unsigned int*)(hDll+ *(unsigned int*)((char*)&lp_Export->AddressOfFunctions + hDll)+ 4* (*(unsigned __int16*)new_INT- (unsigned __int64)*(unsigned int*)((char*)&lp_Export->Base + hDll)));
				}
				else//名称导入
				{
					byname = VA2FA(INT[j]) + gfileBase;
					APIName = byname->Name;
					for (k = 0; ; k++)
					{
						APIName[k] ^= gxorValue;
						if ((APIName[k + 1] ^ gxorValue) == 0)
						{
							APIName[k + 1] ^= gxorValue;
							break;
						}
					}
					printf("	%s\n", APIName);
				}
				
			}
		}
		FreeLibrary(hDll);
	}
	return;
}
```

