# 手动脱壳

环境:upx-4.0.2-win64

测试程序:

```
#include <stdio.h>
int main()
{
    printf("hello UPX!\n");
    return 0;
}
```

编译环境:

1), 没有地址随机化,

2), x86 debug 模式

加壳:

```
E:\re\PE\壳\upx-4.0.2-win64>upx.exe -9 C1.exe
                       Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2023
UPX 4.0.2       Markus Oberhumer, Laszlo Molnar & John Reiser   Jan 30th 2023

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
     38400 ->     12288   32.00%    win32/pe     C1.exe                                                                                                                                                                                         Packed 1 file.

E:\re\PE\壳\upx-4.0.2-win64>
```

然后把C1.exe 放入IDA,寻找大跳转

1),载入IDA

基本上只有一个函数,然后点击stat函数,看他的汇编流程图

2), 寻找大跳转 假设是UPX1:004205B8 

这个地方就是大跳转, 光标对准 jmp near ptr byte_411023,然后空格一下,来到汇编

```
UPX1:004205AF 6A 00                         push    0
UPX1:004205B1 39 C4                         cmp     esp, eax
UPX1:004205B3 75 FA                         jnz     short loc_4205AF
UPX1:004205B5 83 EC 80                      sub     esp, 0FFFFFF80h
UPX1:004205B8 E9 66 0A FF FF                jmp     near ptr byte_411023
UPX1:004205B8                               start endp ; sp-analysis failed
```

记住jmp的地址是0x004205B8

然后把C1.exe放入x32dbg加载

先F9,去往C1.exe的entrypoint

然后CTRL G ,去往 0x004205B8(jmp的地址) 下F2断点

然后开始F9,运行到我们的 jmp 位置

然后F8,去往一个称之为OEP的地方

然后打开我们的x64debg自带插件scylla

![Untitled](%E6%89%8B%E5%8A%A8%E8%84%B1%E5%A3%B3%200fb014feb18e4381b873ade9bd56b954/Untitled.png)

然后

![Untitled](%E6%89%8B%E5%8A%A8%E8%84%B1%E5%A3%B3%200fb014feb18e4381b873ade9bd56b954/Untitled%201.png)

保证scylla那个地方的OEP地址和我们荧光色光标EIP地址相同

然后直接点击dump,然后保存

![Untitled](%E6%89%8B%E5%8A%A8%E8%84%B1%E5%A3%B3%200fb014feb18e4381b873ade9bd56b954/Untitled%202.png)

然后我们还要继续修改它

不要关闭scylla插件和x32dbg

![Untitled](%E6%89%8B%E5%8A%A8%E8%84%B1%E5%A3%B3%200fb014feb18e4381b873ade9bd56b954/Untitled%203.png)

然后点击 IAT Autosearch, Get Imports

然后会有一些提示信息,在没报错的前提下

继续点击FixDump

![Untitled](%E6%89%8B%E5%8A%A8%E8%84%B1%E5%A3%B3%200fb014feb18e4381b873ade9bd56b954/Untitled%204.png)

选中C1_dump.exe (我们之前dump)的

然后打开

然后一切就结束了

fixdump后,会主动生成C1_dump_SCY.exe

![Untitled](%E6%89%8B%E5%8A%A8%E8%84%B1%E5%A3%B3%200fb014feb18e4381b873ade9bd56b954/Untitled%205.png)

C1_dump_SCY.exe就是成品